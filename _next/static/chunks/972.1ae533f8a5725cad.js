"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[972],{9972:(e,t,c)=>{c.r(t),c.d(t,{default:()=>d});var a=c(5155),n=c(2115);let o=()=>new Promise(e=>{let t=[];if(!("RTCPeerConnection"in window))return console.warn("浏览器不支持WebRTC"),e([]);let c=new RTCPeerConnection({iceServers:[]}),a=setTimeout(()=>{c.close(),e(t)},5e3);c.createDataChannel(""),c.createOffer().then(e=>c.setLocalDescription(e)).catch(()=>clearTimeout(a)),c.onicecandidate=c=>{if(!c.candidate){clearTimeout(a),e(t);return}let n=c.candidate.candidate.match(/([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})/);n&&!t.includes(n[1])&&t.push(n[1])}}),r=e=>new Promise((t,c)=>{let a=new WebSocket("ws://".concat(e,":").concat(37521)),n=!1,o=setTimeout(()=>{n||(a.close(),c("连接超时 (".concat(e,")")))},5e3);a.onopen=()=>{n=!0,clearTimeout(o),a.send(JSON.stringify({text:"ping",type:"healthcheck"}))},a.onmessage=n=>{try{let o=JSON.parse(n.data);"pong"===o.text||"received"===o.status?(a.close(),t(e)):c("无效响应")}catch(e){c("消息解析失败")}},a.onerror=e=>{n||c("连接错误: ".concat(e.message))}}),s=e=>{let t=e.split(".").slice(0,3).join(".");return["".concat(t,".1"),"".concat(t,".100"),"".concat(t,".254"),"".concat(t,".2"),"".concat(t,".101"),"".concat(t,".50"),"192.168.43.1","192.168.49.1","10.0.0.1","172.20.10.1"]},i=async()=>{try{let e=await o();if(0===e.length)throw Error("无法获取本地网络信息");let t=e.flatMap(e=>[...s(e),...Array.from({length:20},(t,c)=>"".concat(e.split(".")[0],".").concat(e.split(".")[1],".").concat(e.split(".")[2],".").concat(c+50))]),c=[...new Set(t)].sort(()=>Math.random()-.5);for(let e=0;e<c.length;e+=15){let t=c.slice(e,e+15),a=(await Promise.all(t.map(e=>r(e).catch(()=>null)))).find(e=>null!==e);if(a)return a}throw Error("未发现可用服务端")}catch(e){throw Error(e instanceof Error?e.message:"发现失败")}},l=async e=>{for(let t of["".concat(e,".1"),"".concat(e,".100"),"".concat(e,".254"),"".concat(e,".50"),"".concat(e,".101")])try{let e=await fetch("http://".concat(t,":").concat(37520,"/backend/ip"),{mode:"cors",headers:{"Content-Type":"application/json"}}),{ips:c}=await e.json();if(!Array.isArray(c))continue;for(let e of c)try{return await r(e),e}catch(e){continue}}catch(e){continue}throw Error("API发现失败")},d=()=>{let[e,t]=(0,n.useState)("init"),[c,r]=(0,n.useState)(""),[s,d]=(0,n.useState)([]),h="当前状态：".concat(e," | 服务端IP：").concat(c||"未连接"," | 日志数量：").concat(s.length),u=(0,n.useCallback)(e=>{d(t=>[...t,"".concat(new Date().toLocaleTimeString(),": ").concat(e)])},[]),w=(0,n.useCallback)(async e=>{try{let t="http://".concat(e,":").concat(37520,"/backend/ip");u("验证API连接: ".concat(t));let c=await fetch(t);if(!c.ok)throw Error("HTTP ".concat(c.status));let a=await c.json();u("API验证成功: ".concat(JSON.stringify(a)))}catch(e){throw u("API验证失败: ".concat(e instanceof Error?e.message:"未知错误")),e}},[u]),m=(0,n.useCallback)(async()=>{t("scanning"),u("启动服务端发现流程...");try{let e=await i();u("发现服务端: ".concat(e)),await w(e),r(e),t("connected"),localStorage.setItem("serverIP",e)}catch(c){u("WebSocket发现失败: ".concat(c instanceof Error?c.message:"未知错误"));try{var e;u("尝试API发现...");let c=await o(),a=(null===(e=c[0])||void 0===e?void 0:e.split(".").slice(0,3).join("."))||"192.168.1",n=await l(a);u("通过API发现: ".concat(n)),await w(n),r(n),t("connected"),localStorage.setItem("serverIP",n)}catch(e){u("所有发现方式失败: ".concat(e instanceof Error?e.message:"未知错误")),t("error")}}},[u,w]);return(0,n.useEffect)(()=>{(async()=>{try{let e=localStorage.getItem("serverIP");if(e){u("检测到缓存IP"),r(e),t("connected"),await w(e);return}await m()}catch(e){u("初始化失败: ".concat(e instanceof Error?e.message:"未知错误")),t("error")}})()},[u,m,w]),(0,a.jsxs)("div",{className:"network-discovery",children:[(0,a.jsxs)("div",{className:"status",children:["connected"===e&&(0,a.jsxs)("div",{className:"connected",children:["✅ 已连接至: ",c,(0,a.jsx)("button",{onClick:()=>{localStorage.removeItem("serverIP"),window.location.reload()},children:"重新扫描"})]}),"scanning"===e&&(0,a.jsx)("div",{className:"scanning",children:"\uD83D\uDD04 扫描中..."}),"error"===e&&(0,a.jsxs)("div",{className:"error",children:["❗ 连接失败",(0,a.jsx)("button",{onClick:m,children:"重试"}),(0,a.jsx)("button",{onClick:()=>{let e=prompt("请输入服务端 IP:");e&&(r(e),localStorage.setItem("serverIP",e),t("connected"))},children:"手动输入"})]})]}),(0,a.jsx)("div",{className:"debug-info",children:(0,a.jsx)("pre",{children:h})})]})}}}]);