(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{3170:(e,t,s)=>{Promise.resolve().then(s.bind(s,8013))},8013:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>f});var r=s(5155),a=s(2115);function c(e){let{status:t,messages:s,localIP:a,serverIPs:c,connectionError:n}=e;return(0,r.jsxs)("div",{className:"p-4 bg-gray-100 rounded-lg",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"网络状态"}),a&&(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"mb-2 text-green-600",children:"您的局域网IP："}),(0,r.jsx)("div",{className:"font-mono bg-gray-200 p-2 rounded",children:a})]}),c.length>0&&(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("p",{className:"text-blue-600 mb-2",children:"可用服务IP列表："}),(0,r.jsx)("ul",{className:"list-disc pl-6",children:c.map((e,t)=>(0,r.jsx)("li",{className:"font-mono",children:e},t))})]}),(0,r.jsxs)("div",{className:"mt-6",children:[(0,r.jsx)("p",{className:"text-blue-600 mb-2",children:"WebSocket连接状态："}),"connected"===t&&(0,r.jsx)("div",{className:"text-green-600",children:"✅ 已连接"}),n&&(0,r.jsxs)("div",{className:"text-red-600",children:["❌ ",n]}),"connecting"===t&&(0,r.jsx)("div",{className:"text-yellow-600",children:"正在尝试连接..."})]}),(0,r.jsxs)("div",{className:"mt-6",children:[(0,r.jsx)("h3",{className:"text-sm mb-2",children:"最近接收的消息（最多5条）"}),(0,r.jsx)("ul",{children:s.slice(-5).map((e,t)=>(0,r.jsx)("li",{className:"mb-1 break-all",children:e},t))})]})]})}let n=async()=>{try{let e=e=>/^(?:\d{1,3}\.){3}\d{1,3}$/.test(e)&&e.split(".").every(e=>{let t=parseInt(e,10);return t<=255&&t>=0}),t=await fetch("/api/discover").then(e=>e.json()).then(t=>t.ips.filter(e));if(t.length>0)return t;let s=await fetch("http://localhost:37520/discover"),{ips:r}=await s.json();return r.filter(e)||[]}catch(e){return console.error("发现服务失败:",e),[]}},o=e=>/^(?:\d{1,3}\.){3}\d{1,3}$/.test(e)&&e.split(".").every(e=>{let t=parseInt(e,10);return t>=0&&t<=255})||/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::([0-9a-fA-F]{1,4}:){0,5}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){6}(:[0-9a-fA-F]{1,4}){0,2}|([0-9a-fA-F]{1,4}:){5}(:[0-9a-fA-F]{1,4}){0,3}|([0-9a-fA-F]{1,4}:){4}(:[0-9a-fA-F]{1,4}){0,4}|([0-9a-fA-F]{1,4}:){3}(:[0-9a-fA-F]{1,4}){0,5}|([0-9a-fA-F]{1,4}:){2}(:[0-9a-fA-F]{1,4}){0,6}|[0-9a-fA-F]{1,4}:(:[0-9a-fA-F]{1,4}){0,7}|:(:[0-9a-fA-F]{1,4}){0,8}|fe80::[0-9a-fA-F]{0,4}%[0-9a-zA-Z]{1,})$/i.test(e),l=e=>e.startsWith("192.168.")||e.startsWith("10.")||e.startsWith("172.")||e.startsWith("fe80::")||e.startsWith("::1");async function i(){try{let e=await fetch("/api/local-ip"),t=(await e.json()).ip||"localhost";for(let e of(await n()))try{let t="ws://".concat(e,":37521");if(console.log("Testing IP: ".concat(e)),await m(t))return t}catch(t){console.error("IP ".concat(e," 连接失败: ").concat(t instanceof Error?t.message:String(t)))}try{let e=await u(),t="ws://".concat(e,":37521");if(await m(t))return t}catch(e){console.error("SSDP发现失败:",e)}let s=await d("http://".concat(t,":37520/discover"),2e3);if(s.ok){let{ips:e}=await s.json();for(let t of e.filter(o).filter(l)){let e="ws://".concat(t,":37521");if(await m(e))return e}}throw Error("所有发现方式均失败，未找到可用服务")}catch(t){let e="服务发现失败：".concat(t instanceof Error?t.message:String(t));throw console.error(e),Error(e)}}async function d(e,t){let s=new AbortController;return setTimeout(()=>s.abort(),t),fetch(e,{signal:s.signal})}async function u(){let e=new AbortController;setTimeout(()=>e.abort(),3e3);try{let t=(await fetch("http://239.255.255.250:1900",{method:"M-SEARCH",headers:{HOST:"239.255.255.250:1900",MAN:'"ssdp:discover"',MX:"1",ST:"uuid:ETS2LA-WS-1.0"},signal:e.signal})).headers.get("LOCATION");if(!t)throw Error("SSDP响应缺少LOCATION字段");let s=await fetch(t),{ws_url:r}=await s.json();return r}catch(e){throw Error("SSDP请求失败: ".concat(e instanceof Error?e.message:String(e)))}}async function m(e){return new Promise((t,s)=>{let r=new WebSocket(e),a=setTimeout(()=>{r.close(),s(Error("WebSocket连接超时: ".concat(e)))},5e3);r.onopen=()=>{clearTimeout(a),r.close(),t(!0)},r.onerror=e=>{clearTimeout(a),s(e)}})}var h=s(9509);function f(){let[e,t]=(0,a.useState)(null),[s,o]=(0,a.useState)([]),[l,d]=(0,a.useState)("disconnected"),[u,m]=(0,a.useState)([]),[f,p]=(0,a.useState)([]),x=(0,a.useRef)(null),b=h.env.NEXT_PUBLIC_SERVER_IP||"127.0.0.1",[g,w]=(0,a.useState)(null),j=(e,t)=>{o(s=>[...s,{type:e,message:t,timestamp:new Date}])};(0,a.useEffect)(()=>{(async()=>{try{let e=await fetch("/api/local-ip"),t=await e.json();w(t.ip)}catch(e){console.error("获取本地IP失败:",e)}})()},[]),(0,a.useEffect)(()=>{(async()=>{try{let e=new WebSocket("ws://".concat(b,":37521")),s=setTimeout(()=>e.close(),3e3);e.onopen=()=>{clearTimeout(s),t(b),j("success","检测到本机访问，自动使用服务端IP")},e.onerror=()=>{clearTimeout(s),j("error","自动检测失败，请手动输入服务IP"),t(null)},e.onclose=()=>{clearTimeout(s),j("error","自动检测失败，请手动输入服务IP"),t(null)}}catch(t){let e=t instanceof Error?t.message:String(t)||"未知错误";j("error","服务发现失败: ".concat(e))}})()},[b]);let v=(0,a.useMemo)(()=>"ws://".concat(e||b,":37521"),[e,b]);return(0,a.useEffect)(()=>{if(!e)return;let t=null,s=async()=>{try{let e=await i(),t=new WebSocket(e);x.current=t,d("connecting"),j("info","正在尝试连接..."),t.onopen=()=>{d("connected"),j("success","WebSocket 连接成功")},t.onerror=()=>{d("disconnected"),j("error","WebSocket 连接发生错误")},t.onclose=()=>{d("disconnected"),j("error","WebSocket 连接已关闭"),r()},t.onmessage=e=>{m(t=>[...t,e.data]),j("info","收到消息: ".concat(e.data))}}catch(t){let e=t instanceof Error?t.message:String(t)||"未知错误";d("disconnected"),j("error","连接失败: ".concat(e))}},r=()=>{t=setTimeout(()=>{x.current||s()},5e3)};return s(),r(),()=>{var e;null===(e=x.current)||void 0===e||e.close(),t&&clearTimeout(t)}},[e,v]),(0,a.useEffect)(()=>{(async()=>{try{let e=await n();p(e)}catch(e){j("error","服务发现失败: ".concat(e))}})()},[]),(0,r.jsxs)("div",{className:"container mx-auto p-4",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold mb-4",children:"网络测试工具"}),!e&&(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsx)("div",{className:"text-red-500 mb-2",children:"无法自动检测到服务IP，请手动输入："}),(0,r.jsx)("label",{htmlFor:"ipInput",className:"block mb-2",children:"服务IP地址："}),(0,r.jsx)("input",{type:"text",id:"ipInput",value:e||"",onChange:e=>t(e.target.value),className:"p-2 border rounded w-full",placeholder:b})]}),(0,r.jsx)(c,{status:l,messages:u,localIP:g,serverIPs:f,connectionError:null,discoveryStatus:"completed",discoveredServices:f.length}),(0,r.jsxs)("div",{className:"bg-gray-100 p-4 rounded",children:[(0,r.jsx)("h2",{className:"text-lg font-semibold mb-2",children:"日志"}),(0,r.jsx)("div",{className:"space-y-2",children:s.map((e,t)=>(0,r.jsxs)("div",{className:"p-2 rounded ".concat("error"===e.type?"bg-red-100":"success"===e.type?"bg-green-100":"bg-blue-100"),children:["[",e.timestamp.toLocaleTimeString(),"] ",e.message]},t))})]})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[441,684,358],()=>t(3170)),_N_E=e.O()}]);