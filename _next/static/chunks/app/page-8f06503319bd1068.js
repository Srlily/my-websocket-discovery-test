(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{3170:(e,t,s)=>{Promise.resolve().then(s.bind(s,9886))},9886:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>i});var c=s(5155),a=s(2115);function n(e){let{status:t,messages:s,localIP:a,serverIPs:n,matchingIPs:l,connectionError:r,discoveryStatus:o,discoveredServices:i}=e;return(0,c.jsxs)("div",{className:"p-4 bg-gray-100 rounded-lg",children:[(0,c.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"网络状态"}),a&&(0,c.jsxs)("div",{children:[(0,c.jsx)("p",{className:"mb-2 text-green-600",children:"您的局域网IP："}),(0,c.jsx)("div",{className:"font-mono bg-gray-200 p-2 rounded",children:a})]}),"scanning"===o&&(0,c.jsxs)("div",{className:"text-blue-500",children:["扫描进行中... 已发现 ",i," 个服务"]}),"error"===o&&(0,c.jsx)("div",{className:"text-red-500",children:"服务发现失败"}),n.length>0&&(0,c.jsxs)("div",{className:"mt-4",children:[(0,c.jsx)("p",{className:"text-blue-600 mb-2",children:"服务器IP列表："}),(0,c.jsx)("ul",{className:"list-disc pl-6",children:n.map((e,t)=>(0,c.jsxs)("li",{className:"font-mono",children:[e,l.includes(e)&&"✅ 同一网段"]},t))})]}),l.length>0&&(0,c.jsxs)("div",{className:"mt-6",children:[(0,c.jsx)("p",{className:"text-green-600 font-bold mb-2",children:"可连接的服务器IP："}),(0,c.jsx)("ul",{className:"list-disc pl-6",children:l.map((e,t)=>(0,c.jsx)("li",{className:"font-mono bg-green-100 p-1 rounded",children:e},t))})]}),(0,c.jsxs)("div",{className:"mt-6",children:[(0,c.jsx)("p",{className:"text-blue-600 mb-2",children:"WebSocket连接状态："}),"connected"===t&&(0,c.jsxs)("div",{className:"text-green-600",children:["✅ 已连接到 ",l[0]]}),r&&(0,c.jsxs)("div",{className:"text-red-600",children:["❌ ",r]}),"connected"!==t&&!r&&(0,c.jsx)("div",{className:"text-yellow-600",children:"正在尝试连接..."})]}),(0,c.jsxs)("div",{className:"mt-6",children:[(0,c.jsx)("h3",{className:"text-sm mb-2",children:"最近接收的消息（最多5条）"}),(0,c.jsx)("ul",{children:s.slice(-5).map((e,t)=>(0,c.jsx)("li",{className:"mb-1 break-all",children:e},t))})]})]})}let l=async()=>{try{let e=await fetch("/api/local-ip");return(await e.json()).ip}catch(e){return console.error("获取本地IP失败:",e),null}},r=async()=>{try{let e=await fetch("/api/discover");return(await e.json()).ips||[]}catch(e){return console.error("服务发现失败:",e),[]}},o=e=>/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(e);function i(){let[e,t]=(0,a.useState)(null),[s,i]=(0,a.useState)([]),[d,u]=(0,a.useState)(!1),[m,h]=(0,a.useState)("disconnected"),[b,x]=(0,a.useState)([]),[p,f]=(0,a.useState)(null),[j,g]=(0,a.useState)([]),[N]=(0,a.useState)([]),[v,y]=(0,a.useState)(null),S=(0,a.useRef)(null),[w,P]=(0,a.useState)(null),[k,T]=(0,a.useState)(0),[I,E]=(0,a.useState)("completed"),[W,C]=(0,a.useState)(0),H=(e,t)=>{let s=e=>e.split(".").slice(0,3).join(".");return s(e)===s(t)};(0,a.useEffect)(()=>{(async()=>{try{let e=await r();g(e),C(e.length)}catch(e){O("error","服务发现失败: ".concat(e))}})()},[]),(0,a.useEffect)(()=>{let e=setInterval(async()=>{try{E("scanning");let e=await r();g(e),C(e.length),E("completed")}catch(e){E("error"),O("error","服务发现失败: ".concat(e instanceof Error?e.message:"未知错误"))}},3e4);return()=>clearInterval(e)},[]),(0,a.useEffect)(()=>{if(j.length>0&&p){let s=j.filter(o),c=s.filter(e=>H(e,p))[0]||s[0]||j[0];c&&c!==e&&(t(c),O("success","自动选择服务IP: ".concat(c)))}},[j,p,e]),(0,a.useEffect)(()=>{(async()=>{let e=await l();e&&f(e)})()},[]),(0,a.useEffect)(()=>{(async()=>{let t=await l();e&&t&&P(H(t,e))})()},[e,p]);let _=(0,a.useMemo)(()=>e?(null!=w?w:H(e,p||""))?"ws://".concat(e,":37521"):"ws://ttt.srliy.com:37521/heartbeat":"",[e,w,p]);(0,a.useEffect)(()=>{if(!e)return;let t=null,s=async()=>{S.current&&(S.current.close(),S.current=null);let e=new WebSocket(_);S.current=e,e.onopen=()=>{clearTimeout(t),h("connected"),T(0),O("success","WebSocket已连接到 ".concat(_))},e.onerror=e=>{let c=e.message||"未知WebSocket错误",a=e.type||"未指定";y("错误类型: ".concat(a,", 信息: ").concat(c)),O("error","WebSocket连接错误: ".concat(c)),k<32?(t=setTimeout(s,1e3*Math.pow(2,k)),T(e=>e+1)):(h("disconnected"),O("error","已达到最大重试次数(".concat(32,")")))},e.onclose=e=>{clearTimeout(t);let c=e.code,a=e.reason||"无详细信息";1e3!==c?(y("连接关闭代码: ".concat(c,", 原因: ").concat(a)),O("error","连接意外中断: ".concat(a)),k<32&&(t=setTimeout(s,1e3),T(e=>e+1))):(y("连接已关闭"),O("info","WebSocket连接已关闭"),h("disconnected"))},e.onmessage=e=>{x(t=>[...t,e.data]),O("info","收到服务端消息: ".concat(e.data))}};return s(),()=>{S.current&&S.current.close(),t&&clearTimeout(t)}},[e,_,k]);let O=(e,t)=>{i(s=>[...s,{type:e,message:t,timestamp:new Date}])},M=async()=>{if(!e){O("error","未发现服务，无法进行HTTP测试");return}u(!0),O("info","开始HTTP测试...目标IP: ".concat(e));try{let a=new AbortController,n=setTimeout(()=>a.abort(),5e3),l=await fetch("http://".concat(e,":37520/backend/ip"),{signal:a.signal});if(clearTimeout(n),l.ok){var s,c;let a=await l.json(),n=(null===(s=a.ips)||void 0===s?void 0:s.join(", "))||"无可用IP";O("success","HTTP测试成功！可用IP地址: ".concat(n)),(null===(c=a.ips)||void 0===c?void 0:c.length)&&a.ips[0]!==e&&(t(a.ips[0]),O("info","自动设置服务地址为: ".concat(a.ips[0])))}else O("error","HTTP测试失败，状态码: ".concat(l.status))}catch(e){O("error","HTTP测试异常: ".concat(e instanceof Error?e.message:"未知错误"))}finally{u(!1)}};return(0,a.useEffect)(()=>{console.log("当前 discoveredIp:",e),console.log("生成的 wsUrl:",_)},[e,_]),(0,c.jsxs)("div",{className:"container mx-auto p-4",children:[(0,c.jsx)("h1",{className:"text-2xl font-bold mb-4",children:"网络测试工具"}),(0,c.jsxs)("div",{className:"mb-6",children:[(0,c.jsx)("label",{htmlFor:"ipInput",className:"block mb-2",children:"服务IP地址："}),(0,c.jsx)("input",{type:"text",id:"ipInput",value:e||"",onChange:e=>t(e.target.value),className:"p-2 border rounded w-full",placeholder:"手动输入IP地址"})]}),(0,c.jsxs)("div",{className:"flex gap-4 mb-6",children:[(0,c.jsx)("button",{onClick:()=>{let e=S.current;if(!e||e.readyState!==WebSocket.OPEN){O("error","WebSocket未连接，无法发送测试消息");return}let t=JSON.stringify({text:"测试通知",type:"success",promise:""});e.send(t),O("success","WebSocket测试消息已发送")},disabled:d||"connected"!==m,className:"btn btn-secondary",children:"发送WebSocket测试消息"}),(0,c.jsx)("button",{onClick:M,disabled:!e||d,className:"btn btn-accent",children:"测试HTTP"})]}),(0,c.jsx)(n,{status:m,messages:b,localIP:p,serverIPs:j,matchingIPs:N,connectionError:v,discoveryStatus:I,discoveredServices:W}),(0,c.jsxs)("div",{className:"bg-gray-100 p-4 rounded",children:[(0,c.jsx)("h2",{className:"text-lg font-semibold mb-2",children:"日志"}),(0,c.jsx)("div",{className:"space-y-2",children:s.map((e,t)=>(0,c.jsxs)("div",{className:"p-2 rounded ".concat("error"===e.type?"bg-red-100":"success"===e.type?"bg-green-100":"bg-blue-100"),children:["[",e.timestamp.toLocaleTimeString(),"] ",e.message]},t))})]})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[441,684,358],()=>t(3170)),_N_E=e.O()}]);